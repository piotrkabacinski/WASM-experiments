<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Hash example</title>

    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
      }

      code {
        display: block;
      }

      p {
        display: inline-block;
        padding: 5px;
        background: yellow;
      }

      code,
      p {
        margin-top: 5px;
      }

      textarea {
        width: 300px;
        height: 100px;
        margin-bottom: 10px;
        display: block;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Sha256 example</h1>
    <main>
      <textarea placeholder="Message"></textarea>
      <code>-</code>
      <p>-</p>
    </main>

    <script src="hash.out.js"></script>
    <script>
      {
        let t0;
        let t1;

        const textarea = document.querySelector("textarea");
        const code = document.querySelector("code");
        const paragraph = document.querySelector("p");

        function hashed(pointer, length) {
          t1 = performance.now();

          let hashed = "";

          for (let i = 0; i < length; i++) {
            const char = Module.getValue(pointer + i, "i8");
            hashed += String.fromCharCode(char);
          }

          code.innerHTML = hashed;
          paragraph.innerHTML = `${parseFloat(t1 - t0).toFixed(2)} ms`;
        }

        Module.onRuntimeInitialized = () => {
          textarea.addEventListener("keyup", event => {
            const message = textarea.value.trim();

            // Create int array with encoded message (characters will be transformed to ASCII values).
            const decoded = new Uint32Array(new TextEncoder().encode(message));

            // Reserve memory for decoded message for WASM, and return memory address.
            // WASM doesn't have access to JS memory, therefore we it's need
            // to be allocated independently.
            const buffer = Module._malloc(
              decoded.length * decoded.BYTES_PER_ELEMENT
            );

            // Allocate reserved memory with message data (as int32 array).
            Module.HEAP32.set(decoded, buffer >> 2);

            t0 = performance.now();

            Module.ccall("sum", ["number", "number"], "void", [
              buffer,
              decoded.length
            ]);

            Module._free(buffer);
          });
        };
      }
    </script>
  </body>
</html>
